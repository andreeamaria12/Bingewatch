@{
    ViewData["Title"] = "Bingewatch";
}
@using Personalized_movie_recommendation_system.Infrastructure

@inject IMovieRecommandationService service
@inject UserManager<User> userManger

@if (User.Identity.IsAuthenticated)
{
    <script>

        function switchFavorite(id) {
            if ($("#f-" + id).html() == "Remove from my list")
                removeFavorite(id);
            else addFavorite(id);
        }

        function addFavorite(id) {

            $.ajax({
                url: '/API/AddFavorite?id=' + id,
                type: 'POST',
                success: function (res) {
                    console.log(res);
                    $("#f-" + id).html("Remove from my list");
                },
                error: function (error) { console.log(error) }
            });
        }

        function removeFavorite(id) {

            $.ajax({
                url: '/API/RemoveFavorite?id=' + id,
                type: 'POST',
                success: function (res) {
                    console.log(res);
                    $("#f-" + id).html("Add to my list");
                },
                error: function (error) { console.log(error) }
            });
        }

    </script>
    <div class="m-sm-3">
        <select class="btn btn-secondary dropdown-toggle" asp-items="ViewBag.Genres">
            <option selected value="">All genres</option>
        </select>

        <form class="form-inline float-right">
            <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-secondary my-2 my-sm-0" type="submit">Search</button>
        </form>
    </div>

    @model IEnumerable<Movie>

    List<Movie> movies = service.GetRecommendedMovies();
    User user = await userManger.FindByNameAsync(User.Identity.Name);

    <div>
        @for (var i = 0; i < movies.Count; i++)
        {
            @if (i % 3 == 0)
            {
                @:<div class="row">
                }
            string btnMessage = movies[i].Favorites.Any(x => x.UserId == user.Id) ? "Remove from my list" : "Add to my list";
            <div class="col-sm-6 col-md-4">
                <div class="thumbnail">
                    <img src="@("api/images?name=" + movies[i].ImageUrl)" alt="..." width="200">
                    <div class="caption">
                        <h3>@movies[i].Title</h3>
                        <h5>Rating: @movies[i].Rating</h5>
                        <p>@(movies[i].Description.Substring(0, (movies[i].Description.Length < 200) ? movies[i].Description.Length : 200) + ((movies[i].Description.Length >= 200) ? "..." : string.Empty))</p>
                        <p><a href="/Movie/MoviePage?id=@movies[i].Id" class="btn btn-outline-secondary" role="button">Read more</a> <a class="btn btn-light" id="f-@movies[i].Id" role="button" onclick="switchFavorite(@movies[i].Id);">@btnMessage</a></p>
                    </div>
                </div>
            </div>

            @if (i % 3 == 2 || i == movies.Count - 1)
            {
            @:</div>
        }



        }
    </div>


}
else
{
    <div class="text-center">
        <h1>Welcome</h1>
    </div>
}


